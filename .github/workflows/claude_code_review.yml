# Název workflow, který se zobrazí na GitHubu
name: Claude AI Code Review

# Spouštěč (trigger) - tato akce se spustí při každém otevření nebo aktualizaci Pull Requestu na větev 'main'
on:
  pull_request:
    branches:
      - main

# Úlohy, které se mají provést
jobs:
  code-review:
    # Běží na virtuálním stroji s Ubuntu
    runs-on: ubuntu-latest

    steps:
      # Krok 1: Získá kód z repozitáře, aby k němu měla akce přístup
      - name: Checkout Code
        uses: actions/checkout@v4

      # Krok 2: Nastaví prostředí (zde Node.js, pokud je Claude Code nainstalován přes npm)
      # Nahraďte podle toho, jak máte Claude Code nainstalován (např. setup-python)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Krok 3: Instalace Claude Code (příklad pro npm)
      - name: Install Claude Code
        run: npm install -g claude-code-cli # Nahraďte skutečným instalačním příkazem

      # Krok 4: Spuštění revize a publikování komentáře
      - name: Run Claude AI Review and comment if needed
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          # Získání diffu pro daný PR
          gh pr diff $PR_NUMBER --repo $REPO > pr.diff

          # Vlož diff do promptu a zavolej Claude
          REVIEW_COMMENT=$(claude --model claude-3-opus -p "$(cat .claude/prompts/pr_review_prompt.md)" -f pr.diff)

          # Zkontroluj, jestli je výstup skutečná připomínka, nebo jen "✅ No issues..."
          if [[ "$REVIEW_COMMENT" != "✅ No issues found in the PR." ]]; then
            echo "Posting review comment..."
            gh pr comment $PR_NUMBER --repo $REPO --body "$REVIEW_COMMENT"
          else
            echo "No issues found. Skipping comment."
          fi
